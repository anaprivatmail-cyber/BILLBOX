[build]
  base = "site"
  publish = "."
  command = "rm -rf functions && cp -R ../netlify/functions ./functions && npm --prefix functions install --omit=dev && npm --prefix functions run test:ocr"
  functions = "functions"

[functions]
  directory = "functions"
  node_bundler = "esbuild"
  external_node_modules = ["@supabase/supabase-js", "google-auth-library", "pdf-parse", "sharp", "stripe"]

[build.environment]
  NODE_VERSION = "20"
  NPM_VERSION = "10"
  # Netlify secrets scanning can false-positive on third-party deps/examples inside installed function node_modules
  # and local build artifacts. Omit those paths rather than disabling scanning globally.
  SECRETS_SCAN_OMIT_PATHS = "functions/node_modules/**,.netlify/**"

[[scheduled]]
  path = "/.netlify/functions/cleanup-entitlements"
  schedule = "0 3 * * *"
